---
title: "Multi-Omics Data Analysis Notebook"
author: "CNSB"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    toc: yes
    code_folding: hide
---

========================================================

```{r format_variables}
############################################
##
##  SET FILE PATHS FOR LOCAL INSTALL
##
############################################

## R libraries path
#libraries_path = '/project/cnsbomic/Tools/R'

## Inherit paths
#inherit_paths = "TRUE"

# Loaded from Parameters.R

############################################

## IF NOT RUNNING WITH PIPELINE, SET WORKING DIRECTORY
# working_dir <- PATH TO DATA FILES
# setwd(working_dir)

############################################

# Databases for enrichR search
search_databases <- c("KEGG_2016", "GO_Biological_Process_2017b", #"GO_Cellular_Component_2017b",
                      "GO_Molecular_Function_2017b", "HMDB_Metabolites", "Reactome_2016",
                      "MSigDB_Oncogenic_Signatures");

############################################

source('Parameters.R')

```

```{r libraries}

# Make output subdirectories
output_subdir <- paste( gsub("\\.","", make.names(project_name)), gsub("-","",Sys.Date()), sep="_")
output_files_subdir <- paste(output_subdir,"Files", sep="/")
output_plots_subdir <- paste(output_subdir,"Plots", sep="/")
output_path <- file.path(working_dir, output_subdir)
output_files_path <- file.path(working_dir, output_files_subdir)
output_plots_path <- file.path(working_dir, output_plots_subdir)
output_contrast_path <- output_plots_path
if( dir.exists(output_path) == FALSE ) {dir.create(output_path)}
if( dir.exists(output_files_path) == FALSE ) {dir.create(output_files_path)}
if( dir.exists(output_plots_path) == FALSE ) {dir.create(output_plots_path)}

# Set library path for BU SCC
if(inherit_paths==TRUE) { .libPaths(libraries_path) }

# Load pipeline libraries
suppressPackageStartupMessages({
library(Biobase)
library(limma)
library(knitr)
library(ggplot2)
library(ggrepel)
library(calibrate)
library(preprocessCore)
library(RColorBrewer)
library(viridis)
library(reshape2)
library(tidyr)
library(dplyr)
library(stringr)
library(grid)
library(gridExtra)
library(lattice)
library(VennDiagram)
library(UpSetR)
library(corrplot)
library(heatmaply)
library(edgeR)
library(Glimma)
library(openxlsx)
library(ComplexHeatmap)
library(RCurl)

if(enrichr_section){ library(enrichR) }

if(gsea_section){
  library(httr)
  library(RJSONIO)
  library(RCy3)
  #library(EasycyRest)
}

#library(sva) # combat/batch correction
#library(hmdbQuery) # metabolite annotation info
#library(MetaboAnalystR)
})

# Source function file
source(file.path(notebook_dir,"notebookFunctions.R"))

```

# Load Search Output and Process
```{r load_data_qc}
############################################
# The omicsList object is a list of lists. Each top level represents a different omics type.
#
# omicsList[[i]][[1]] "dataType" is the name of the omics set
# omicsList[[i]][[2]] "dataFormat" is the data format of the omics set.
# omicsList[[i]][[3]] "filename" is the filename/path for the omics data set.
# omicsList[[i]][[4]] "RawData" is the raw data.
# omicsList[[i]][[5]] "eSet" is the working eset object
# omicsList[[i]][[6]] "topVariable" is the index of the most variable features
# omicsList[[i]][[7]] "fit" is the limmaFit output of eBayes
# omicsList[[i]][[8]] "ratio" difference between samples when not enough replicates
# omicsList[[i]][[9]] 
# omicsList[[i]][[10]] "siteNorm" is site data normalized to protein groups
# omicsList[[i]][[11]] "siteNorm_fit" is the limmaFit output of eBayes
# omicsList[[i]][[12]] "prebatch_eset" is the normalized but pre-batch corrected eset, if applicable
# omicsList[[i]][[14]] is the un-normalized eset object - for debugging only
#
############################################

# Make index variables
metab_data_index <- c();  # index of all Metabolite data
mz_data_index <- c();     # index of all data with mz
phos_data_index <- c();   # index of Phospho Site Data (from MQ)
sites_data_index <- c();  # index of all site data (from MQ)
sites_norm_index <- c();  # index of site data normalized to proteome (if applicable)
gene_data_index <- c();   # index of all data  with Gene (HGNC Symbols)
prot_data_index <- c();   # index of all data with Protein (Uniprot IDs)
prot_groups_index <- c(); # index of all Protein Groups Data (MQ)

# Import annotation file
annot <- data.frame(openxlsx::read.xlsx(annotation_filename, 1, colNames=FALSE)); # read annotation
contrastgroups <- gsub("\\.","", make.names(na.omit(t(annot[1,-1:-3]))));
annot<-annot[c(-1,-4),];

# Make omicsList object
omicsList <- vector("list", (nrow(annot)-2) )

for (i in 1:(nrow(annot)-2) ){
  omicsList[[i]] <- vector("list", 14);
  omicsList[[i]][1] <- make.names(annot[i+2,1]);
  names(omicsList[[i]])[1] <- gsub("\\.","", make.names("dataType"));
  omicsList[[i]][2] <- make.names(annot[i+2,2]);
  names(omicsList[[i]])[2] <- "dataFormat";
  if(omicsList[[i]][["dataFormat"]]=="Metabolites"){ metab_data_index <- c(metab_data_index, i)  };
  if(omicsList[[i]][["dataFormat"]]=="Phospho.Sites..MQ."){ phos_data_index <- c(phos_data_index, i)  };
  if(omicsList[[i]][["dataFormat"]]=="Protein.Groups..MQ."){ prot_groups_index <- c(prot_groups_index, i) };
  if(grepl(".Sites..MQ.",omicsList[[i]][["dataFormat"]]) ){ sites_data_index <- c(sites_data_index, i)  };
  omicsList[[i]][[3]] <- annot[i+2,3];
  names(omicsList[[i]])[3] <- "filename";
}

# Load metabolite libraries
if(length(metab_data_index) > 0){ suppressPackageStartupMessages({
  library(MetaboAnalystR)
  library(hmdbQuery)
}) }

# Format annotation table
annot[3:nrow(annot),3] <- annot[3:nrow(annot),1];
annot <- t(annot[,-1:-2]);
rownames(annot) <- NULL;
colnames(annot)<-make.unique(annot[1,]);
annot<-data.frame((annot[-1,]));
annot[,"Group"]<-gsub("\\.","",make.names(annot[,"Group"]))
annot[,"SampleName"]<-gsub("\\.","",make.names(make.unique(as.character(annot[,"SampleName"]))))

# Get batch information if there
try({
  annot2 <- openxlsx::read.xlsx(annotation_filename, 2, colNames=FALSE, rowNames=TRUE)
  annot2 <- data.frame(t(annot2))
  rownames(annot2) <- NULL;
  annot <- data.frame(cbind(annot, annot2))
}, silent=TRUE)

# Add file paths to file names (w/chanbge for generating txt report)
for (i in 1:length(omicsList)){
  if( (".MQ." %in% omicsList[[i]][["dataFormat"]]) & txtFolder==TRUE ) { 
    omicsList[[i]][[3]] <- file.path(working_dir, "txt", omicsList[[i]][[3]]) 
  } else {
    omicsList[[i]][[3]] <- file.path(working_dir, omicsList[[i]][[3]])
  }
}

# Import data and make eset objects
for (i in 1:length(omicsList)){
    
  if( grepl(".csv$", omicsList[[i]][[3]]) ) { file_ext_sep <- ","; } else { file_ext_sep <- "\t"; }
  omicsList[[i]][[4]] <- data.frame(read.delim(omicsList[[i]][[3]], header=TRUE, stringsAsFactors=FALSE,
                                               sep=file_ext_sep, check.names=FALSE));
  names(omicsList[[i]])[4] <- "RawData";
  
  omicsList[[i]][[5]] <- makeEset(data=omicsList[[i]][[4]], annotate=annot, type=omicsList[[i]][[1]], 
                                  data_format=omicsList[[i]][[2]], uniprot_annotation=query_web);
  names(omicsList[[i]])[5] <- "eSet";
  #omicsList[[i]][[14]] <- omicsList[[i]][[5]] # use for debugging
    
  if( "Gene" %in% colnames(fData(omicsList[[i]][["eSet"]])) ) { gene_data_index <- c(gene_data_index, i) };
  if( "Protein" %in% colnames(fData(omicsList[[i]][["eSet"]])) ) { prot_data_index <- c(prot_data_index, i) };
  if( "mz" %in% colnames(fData(omicsList[[i]][["eSet"]])) ) { mz_data_index <- c(mz_data_index, i) };
}

```

```{r global_options, echo=FALSE}
knitr::opts_chunk$set(fig.path=paste(output_files_path,"/Images/", sep=""),messages=FALSE, fig.width=8, fig.height=12, knitr.duplicate.label="allow")
```

```{r child=file.path(notebook_dir, 'Notebook_1_Expl.Rmd')}
```

```{r child=file.path(notebook_dir, 'Notebook_2_Diff.Rmd'), eval=runDifferential}
```

```{r }
#child=file.path(notebook_dir, 'Notebook_3_Enrch.Rmd'), eval=runDifferential}
```

```{r }
#child=file.path(notebook_dir, 'Notebook_4_Integ.Rmd'), eval=runDifferential}
```

---

# Session Info

```{r, code=readLines(file.path(working_dir, "Parameters.R")) }
```

```{r session_info}
sessionInfo()
```

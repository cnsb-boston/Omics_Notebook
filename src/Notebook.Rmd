---
title: "Multi-Omics Data Analysis Notebook"
author: "CNSB"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: united
    toc: yes
    code_folding: hide
---

========================================================

```{r format_variables, echo=FALSE}
  
# source variable file
source("Variables.R")

# Databases for enrichR search
search_databases <- c("KEGG_2016", "GO_Biological_Process_2017b", #"GO_Cellular_Component_2017b",
                      "GO_Molecular_Function_2017b", "HMDB_Metabolites", 
                      "MSigDB_Oncogenic_Signatures");

# options
run_gsea <- gsea_section # if GSEA has already been run, set to false and include results in directory
enrichment_map <- isInteractive # only run enrichment map if interactive session

```

```{r libraries, warning=FALSE, message=FALSE}
tryCatch(expr={
# Make output subdirectories
output_subdir <- paste( gsub("\\.","", make.names(project_name)), gsub("-","",Sys.Date()), sep="_")
output_files_subdir <- paste(output_subdir,"Files", sep="/")
output_plots_subdir <- paste(output_subdir,"Plots", sep="/")
output_path <- file.path(working_dir, output_subdir)
output_files_path <- file.path(working_dir, output_files_subdir)
output_plots_path <- file.path(working_dir, output_plots_subdir)
if( dir.exists(output_path) == FALSE ) {dir.create(output_path)}
if( dir.exists(output_files_path) == FALSE ) {dir.create(output_files_path)}
if( dir.exists(output_plots_path) == FALSE ) {dir.create(output_plots_path)}

# Set library path for BU SCC
if(BUSCC==TRUE) { .libPaths("/project/cnsbomic/Tools/R") }

# Load pipeline libraries
library(gdata)
library(Biobase)
library(limma)
library(knitr)
library(ggplot2)
library(ggrepel)
library(calibrate)
library(preprocessCore)
library(RColorBrewer)
library(viridis)
library(reshape2)
library(tidyr)
library(dplyr)
library(grid)
library(gridExtra)
library(lattice)
library(enrichR)
library(VennDiagram)
library(heatmaply)
library(edgeR)
library(Glimma)
library(openxlsx)
library(ComplexHeatmap)
library(RCurl)
library(r2cytoscape)
library(httr)
library(RJSONIO)
library(devtools)
library(r2cytoscape)
library(EasycyRest)

# Source function files
source(file.path(notebook_dir,"notebookFunctions.R"))
source(file.path(notebook_dir, "notebookFunctions_Prot_normQC.R"))
source(file.path(notebook_dir, "notebookFunctions_Prot_Diff.R"))
}, error=function(e){print("Error loading libraries and setting directories")} )

```


# Load Search Output and Process
```{r load_data_qc}
# Add error checking for finding files (annotation and data), and making loading/making eset

# Import annotation file
annot <- data.frame(openxlsx::read.xlsx(annotation_filename, 1, colNames=FALSE)); # read annotation
contrastgroups <- gsub("\\.","", make.names(na.omit(t(annot[1,-1:-3]))));
annot<-annot[c(-1,-4),];

# Make omicsList object
omicsList <- vector("list", (nrow(annot)-2) )
for (i in 3:nrow(annot)){
  omicsList[[i-2]] <- vector("list", 12);
  omicsList[[i-2]][1] <- make.names(annot[i,1]);
  names(omicsList[[i-2]])[1] <- gsub("\\.","", make.names("dataType"));
  omicsList[[i-2]][2] <- make.names(annot[i,2]);
  names(omicsList[[i-2]])[2] <- "dataFormat";
  omicsList[[i-2]][[3]] <- annot[i,3];
  names(omicsList[[i-2]])[3] <- "filename";
}

# Format annotation table
annot[3:nrow(annot),3] <- annot[3:nrow(annot),1];
annot <- t(annot[,-1:-2]);
rownames(annot) <- NULL;
colnames(annot)<-annot[1,];
annot<-data.frame((annot[-1,]));
annot[,"Group"]<-gsub("\\.","",make.names(annot[,"Group"]))
annot[,"SampleName"]<-gsub("\\.","",make.names(annot[,"SampleName"]))

# Changes for generating txt report
if(txtFolder==TRUE) {
  for (i in 1:length(omicsList)){
    omicsList[[i]][[3]] <- file.path(working_dir, "txt", omicsList[[i]][[3]])
  }
} else {
  for (i in 1:length(omicsList)){
    omicsList[[i]][[3]] <- file.path(working_dir, omicsList[[i]][[3]])
  }
}

# Import data and make eset objects
if(!newcontrastonly){
  for (i in 1:length(omicsList)){
    omicsList[[i]][[4]] <- data.frame(read.delim(omicsList[[i]][[3]], header=TRUE, stringsAsFactors=FALSE, check.names=FALSE));
    names(omicsList[[i]])[4] <- "RawData";
    
    omicsList[[i]][[5]] <- makeEset(data=omicsList[[i]][[4]], annotate=annot, type=omicsList[[i]][[1]], 
                                    data_format=omicsList[[i]][[2]], cutoff=zero_percent)
    names(omicsList[[i]])[5] <- "eSet";
    
    print(paste(omicsList[[i]][[1]], ": ", nrow(omicsList[[i]][[4]]), " features detected in raw data.", sep=""))
    print(paste(omicsList[[i]][[1]], ": ", nrow(omicsList[[i]][[5]]), " features detected in filtered data.", sep=""))
  }
}

# Load previously saved data - saves time
if(newcontrastonly){
  for (i in 1:length(omicsList)){
    omicsList[[i]][[5]] <- readRDS(file=file.path(output_files_path, paste("Data_eset_", omicsList[[i]][[1]], ".RDS", sep="")))
    names(omicsList[[i]])[5] <- "eSet";
    print(paste(omicsList[[i]][[1]], ": ", nrow(omicsList[[i]][[5]]), " features detected in processed data.", sep=""))
  }
}

```


```{r global_options, echo=FALSE}
knitr::opts_chunk$set(fig.path=paste(output_files_path,"/Images/", sep=""),messages=FALSE, fig.width=8, fig.height=12, knitr.duplicate.label="allow")
```

```{r child=file.path(notebook_dir, 'Proteomics_Notebook_NormQC.Rmd')}
```

```{r child=file.path(notebook_dir, 'Proteomics_Notebook_Diff.Rmd'), eval=runDifferential}
```


# Session Info
```{r session_info}
sessionInfo()
```

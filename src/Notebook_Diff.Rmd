# Differential Analysis  

### Limma
```{r limma}
#limma
for(i in 1:length(omicsList)){

  # Create a model matrix and lmFit based on group - For more complex models, edit the following code in this chunk.
  f <- factor(pData(omicsList[[i]][["eSet"]])$Group)#, levels=contrastgroups); 
  #paste(pData(eset)Group, pData(eset1)$Disease, sep='.'))
  design <- model.matrix(~ 0 + f);
  colnames(design) <- make.names(levels(f));
  fit1 <- lmFit( omicsList[[i]][["eSet"]], design);
  
  # Make all contrasts between groups
  contrast_strings <- "";
  for (j in 1:(length(contrastgroups)-1)){
    for (k in (j+1):length(contrastgroups)){
      contrast_strings <- c(contrast_strings, paste(contrastgroups[k],'-',contrastgroups[j], sep=''));
  }  }
  contrast_strings <- contrast_strings[-1]
  contrast_matrix <- makeContrasts(contrasts=contrast_strings, levels=design);
    
  # Add the fit object to the omicsList
  fit1 <- contrasts.fit(fit1, contrast_matrix);
  omicsList[[i]][[7]] <- eBayes(fit1);
  names(omicsList[[i]])[7] <- "fit";

  # Summary of the fit
  end_col <- ncol(topTable(omicsList[[i]][["fit"]], adjust="BH"))
  start_col <- end_col - (3+length(contrast_strings))
  print(topTable(omicsList[[i]][["fit"]], adjust="BH")[,seq(start_col, end_col)])
  
  # Save the decide tests results and print summary 
  omicsList[[i]][[10]] <- decideTests(omicsList[[i]][["fit"]]);
  names(omicsList[[i]])[10] <- "dt";
  #print(summary(omicsList[[i]][["dt"]]))
  #vennDiagram(omicsList[[i]][["dt"]]);

  # Save the information about the number of coeficients and the contrasts names
  omicsList[[i]][[8]] <- length(contrast_strings)
  names(omicsList[[i]])[8] <- "numCoef"
  omicsList[[i]][[9]] <- contrast_strings
  names(omicsList[[i]])[9] <- "contrasts"
  
}

# Make differential directory
output_contrast_subdir <- paste(output_subdir,"Differential", sep="/" )
output_contrast_path <- file.path(working_dir, output_contrast_subdir)
if( dir.exists(output_contrast_path) == FALSE ) { dir.create(output_contrast_path) }

```

---

### Volcano plots
```{r volcano}
output_links<-"";

for(i in 1:length(omicsList)){
  for(c in 1:omicsList[[i]][["numCoef"]]){
    # For the data set and coefficient, make the summary table and name
    top_sum <- topTable(omicsList[[i]][["fit"]], adjust="BH", n=Inf, sort.by='p', coef=c);
    type_name <- paste(omicsList[[i]][["dataType"]],omicsList[[i]][["contrasts"]][c], sep="_");
    
    # run Volcan function
    drawVolcano(top_sum, type=type_name);
    
    # Make output hyperlinks for markdown
    add_link <- paste("[ ",type_name, " ](", output_contrast_subdir,"/volcano_",type_name,".pdf)", sep="")
    output_links <- paste(output_links, add_link, sep=" | " )   
  }
  output_links <- paste(output_links, "  \n", sep="" );
}

```
Click to view static volcano plots:  
`r { output_links }`  

---

### Differential Static Heatmaps
```{r heatmaps_diff}
output_links<-"";

for(i in 1:length(omicsList)){
  for(c in 1:omicsList[[i]][["numCoef"]]){
    # For the data set and coefficient, make the summary table and name
    top_sum <- topTable(omicsList[[i]][["fit"]], adjust="BH", n=Inf, sort.by='p', coef=c, p.value=adjpcutoff);
    if (nrow(top_sum)<100){ top_sum <- topTable(omicsList[[i]][["fit"]], adjust="BH", n=100, sort.by='p', coef=c); }
    type_name <- paste(omicsList[[i]][["dataType"]],omicsList[[i]][["contrasts"]][c], sep="_");
    
    # run heatmap function
    drawHeatmaps(eset=omicsList[[i]][["eSet"]], limmaSig=top_sum, type=type_name, show_row_names=FALSE);
    
    if(omicsList[[i]][["numCoef"]]>1) {
        drawHeatmaps(eset=omicsList[[i]][["eSet"]][,pData(omicsList[[i]][["eSet"]])$Group %in% unlist(strsplit(omicsList[[i]][["contrasts"]][c], "-")) ], limmaSig=top_sum,
                        type=paste(type_name, "_subgroup", sep="") );
        output_links <- paste(output_links, "  \n", sep="" );
    }
    
    # Make output hyperlinks for markdown
    add_link <- paste("[ ",type_name, " ](", output_contrast_subdir,"/heatmaps_",type_name,".pdf)", sep="")
    if(omicsList[[i]][["numCoef"]]>1){ add_link <- paste(add_link, " | [ ",type_name, "_subgroup ](", output_contrast_subdir,"/heatmaps_",type_name,"_subgroup.pdf)", sep=""); }
    output_links <- paste(output_links, add_link, sep=" | " ); 
  }
  output_links <- paste(output_links, "  \n", sep="" );
}

```
Click to view static heatmap plots:  
`r { output_links }`   


---

### Interactive Volcano Plots
```{r interactive_volcano}
output_links<-"";

for(i in 1:length(omicsList)){
  for(c in 1:omicsList[[i]][["numCoef"]]){
    top_sum <- topTable(omicsList[[i]][["fit"]], adjust="BH", n=Inf, sort.by='p', coef=c);
    type_name <- paste(omicsList[[i]][["dataType"]],omicsList[[i]][["contrasts"]][c], sep="_");

    interactiveVolcano(eset=omicsList[[i]][["eSet"]], fit=omicsList[[i]][["fit"]], dt=omicsList[[i]][["dt"]],
                     limmaSig=top_sum, type=type_name, col=c);

    add_link <- paste("[ ",type_name, " ](", output_contrast_subdir,"/InteractivePlots/Volcano-Plot_",type_name,".html)", sep="");
    output_links <- paste(output_links, add_link, sep=" | " ); 
  }
  output_links <- paste(output_links, "  \n", sep="" ); 
}


```
Click to view interactive Volcano plots:  
`r { output_links }`   


---

## Enrichment
`r if(enrichr_section & species!="Other" ){"### EnrichR"}`
```{r enrichr, results='hide' }
# enrichR, save GSEA ranked list, eventually add run GSEA
output_links<-"";

if(enrichr_section==TRUE & species!="Other" ){
  
  # Run Enrichr for each data type
  for(i in 1:length(omicsList)){ 
    if(omicsList[[i]][["dataFormat"]]!="Metabolites") {
      for(c in 1:omicsList[[i]][["numCoef"]]){
        try({
        top_sum <- topTable(omicsList[[i]][["fit"]], adjust="BH", n=Inf, sort.by='p', coef=c, p.value=adjpcutoff);
        if (nrow(top_sum)<50){ top_sum <- topTable(omicsList[[i]][["fit"]], adjust="BH", n=50, sort.by='p', coef=c); }
        type_name <- paste(omicsList[[i]][["dataType"]],omicsList[[i]][["contrasts"]][c], sep="_");
      
        runEnrichR(top_sum[, c("Gene", "logFC") ], type=type_name) 

      # Make output hyperlinks for markdown
        add_link <- paste("[ ",type_name, "-Up ](", output_contrast_subdir,"/enrichr_results_",type_name,"_up.txt) | ",
                          "[ ",type_name, "-Down ](", output_contrast_subdir,"/enrichr_results_",type_name,"_down.txt)", sep="")
        output_links <- paste(output_links, add_link, sep="  \n" )
        }, silent=TRUE)
      }
    }
  }
  
  # Run enrichr for combined data
  try({
  if(length(omicsList)>1){
    for(c in 1:omicsList[[1]][["numCoef"]]){
        type_name <- paste("Combined",omicsList[[1]][["contrasts"]][c], sep="_");
        gene_table <- topTable(omicsList[[1]][["fit"]], adjust="BH", n=Inf, sort.by='p', coef=c, p.value=adjpcutoff)
        if (nrow(gene_table)<50){ gene_table<-topTable(omicsList[[1]][["fit"]], adjust="BH", n=50, sort.by='p', coef=c) }
        gene_table <- gene_table[, c("Gene", "logFC") ];
        
        for(i in 2:length(omicsList)){
          if( (omicsList[[i]][["dataFormat"]]!="Metabolites")  ) {
            add_to_table <- topTable(omicsList[[i]][["fit"]], adjust="BH", n=Inf, sort.by='p', coef=c, p.value=adjpcutoff);
            if (nrow(add_to_table)<50){ add_to_table<-topTable(omicsList[[i]][["fit"]], adjust="BH", n=50, sort.by='p', coef=c); }
            add_to_table <- add_to_table[, c("Gene", "logFC") ];
            gene_table <- rbind(gene_table, add_to_table)
          }
        }
      }

      runEnrichR(gene_table[, c("Gene", "logFC") ], type=type_name )
        
      # Make output hyperlinks for markdown
      add_link <- paste("[ ",type_name, "-Up ](", output_contrast_subdir,"/enrichr_results_",type_name,"_up.txt) | ",
                      "[ ",type_name, "-Down ](", output_contrast_subdir,"/enrichr_results_",type_name,"_down.txt)  ", sep="")
      output_links <- paste(output_links, add_link, sep="  \n" )
    }
  }, silent=TRUE)
}

```
`r if(enrichr_section & species!="Other"){"Click below to view enrichR results:  "}`  
`r if(enrichr_section & species!="Other"){ output_links } `   

---

### Save Data
```{r save_files_diff }
# save for omics integrator, expression matrix, expression set RDS, ranked list for GSEA

for(i in 1:length(omicsList)){
  for (c in 1:(omicsList[[1]][["numCoef"]])){
    top_sum <- topTable(omicsList[[i]][["fit"]], adjust="BH", n=Inf, sort.by='p', coef=c);
    type_name <- paste(omicsList[[i]][["dataType"]],gsub("-","_",omicsList[[i]][["contrasts"]][c]), sep="_");
    
    saveFiles(omicsList[[i]][["eSet"]], limmaRes=top_sum, type=type_name, contrast_name=omicsList[[i]][["conrasts"]][c])
  }
}

if(length(omicsList)>1){ try({
  for (c in 1:(omicsList[[1]][["numCoef"]])){
    top_sum <- topTable(omicsList[[1]][["fit"]], adjust.method="BH", n=Inf, sort.by='p', coef=c)
    ranked <- cbind(top_sum[,"Gene"], sign(top_sum[,"logFC"]) * -log10(top_sum[,"adj.P.Val"])) 

    for(i in 2:length(omicsList)){
      if( ("Gene" %in% colnames(omicsList[[1]][["eSet"]]) )  ) {
        top_sum <- topTable(omicsList[[i]][["fit"]], coef=c, adjust.method="BH", n=Inf, sort.by='p')
        ranked1 <- cbind(top_sum[,"Gene"], sign(top_sum[,"logFC"]) * -log10(top_sum[,"adj.P.Val"])) 
        ranked <- rbind(ranked, ranked1)
      }
    }
  
    colnames(ranked)<-c("GeneName", "rank")
    ranked <- ranked[ranked[,"GeneName"]!="", ]
    ranked <- ranked[order(abs(as.numeric(ranked[,"rank"])), decreasing=TRUE),]
    ranked <- ranked[!duplicated(ranked[,"GeneName"]),]
    ranked <- ranked[order(as.numeric(ranked[,"rank"]), decreasing=TRUE),]
    output_filename <- file.path(output_contrast_path,paste("GSEA_combined",gsub("-","_",omicsList[[i]][["contrasts"]][c]),".rnk", sep=""));
    write.table(x=ranked, file=output_filename, sep='\t',row.names=FALSE, col.names=TRUE, quote=FALSE)
  }
  })
} 
  
if(runDifferential==TRUE && saveXlsx==TRUE){   
  
  # Save excel file summary for collaborators
  wbOut <- createWorkbook()

  for(i in 1:length(omicsList)){
    writeDataToSheets(wb=wbOut, eset=omicsList[[i]][["eSet"]], limmaFit=omicsList[[i]][["fit"]], 
                      type=omicsList[[i]][["dataType"]], data_format=omicsList[[i]][["dataFormat"]]); 
  }  
  
  output_filename=file.path(output_path, paste(gsub("\\.","",make.names(project_name)), "_Summary", ".xlsx", sep=""))
  saveWorkbook(wbOut, file=output_filename, overwrite=TRUE)
  
}
```

---

`r if( gsea_section & species!="Other" ){"### GSEA and EnrichmentMap"}`
```{r GSEA}
## This sections is based on the Bader Lab Enrichment Map Workflow.
## The connection between R and cytoscape must be configured for proper functioning.
## For more info: baderlab.github.io/Cytoscape_workflows/EnrichmentMapPipeline/

output_network_file <- FALSE;
output_links <- "";

# options
run_gsea <- gsea_section # if GSEA has already been run, set to false and include results in directory
enrichment_map <- isInteractive # only run enrichment map if interactive session

if(gsea_section==TRUE & species!="Other" ) { try({
  
  #gsea_jar <- "/project/cnsbomic/Tools/gsea-3.0.jar" #DEFINED IN PARAMETERS

  analysis_names <- vector("list", omicsList[[1]][["numCoef"]])
  for (i in 1:length(analysis_names)){
    analysis_names[[i]] <- gsub("-", "_", omicsList[[1]][["contrasts"]][i])
  }

  gsea_working_dir <- "GSEA"#gsub("\\.", "_", paste("GSEA_", analysis_name, sep=""))
  gsea_working_path <- file.path(output_path, gsea_working_dir)
  if( dir.exists(gsea_working_path) == FALSE ) { dir.create(gsea_working_path) }
  
  rnk_files <-vector("list", omicsList[[1]][["numCoef"]])
  for (i in 1:length(analysis_names)){  
    if( file.exists(paste(output_contrast_path, "/GSEA_combined",gsub("-","_",omicsList[[1]][["contrasts"]][i]),".rnk", sep="")) ){ 
      rnk_files[[i]] <- paste(output_contrast_path, "/GSEA_combined",gsub("-","_",omicsList[[1]][["contrasts"]][i]),".rnk", sep="")
    } else { rnk_files[[i]] <- paste(output_contrast_path,"/GSEA_",gsub("-","_",omicsList[[1]][["dataType"]]),"_",gsub("-","_",omicsList[[1]][["contrasts"]][i]),".rnk", sep="") }
  }
  expression_file <- file.path(paste(output_files_subdir, "/Expression_matrix_",omicsList[[1]][["dataType"]],".txt", sep=""))

  suppressWarnings({ suppressMessages({
  # Only if you need a new GMT file
  if(species=="Mouse"){gmt_url = "http://download.baderlab.org/EM_Genesets/current_release/Mouse/symbol/"}
  if(species=="Human"){gmt_url = "http://download.baderlab.org/EM_Genesets/current_release/Human/symbol/"}
  filenames = getURL(gmt_url)   #list all the files on the server
  tc = textConnection(filenames)
  contents = readLines(tc)
  close(tc)
  #get the gmt that has all the pathways and does not include terms inferred from electronic annotations(IEA), start with gmt file that has pathways only
  rx = gregexpr("(?<=<a href=\")(.*.GOBP_AllPathways_no_GO_iea.*.)(.gmt)(?=\">)",contents, perl = TRUE)
  gmt_file = unlist(regmatches(contents, rx))
  dest_gmt_file <- paste(gsea_working_path,paste("Supplementary_Table3_",gmt_file,sep="") ,sep="/")
  download.file(paste(gmt_url,gmt_file,sep=""),destfile=dest_gmt_file)
  }) })
  
  if(run_gsea){
    for (i in 1:length(analysis_names)){
      analysis_name <- analysis_names[[i]]
      rnk_file <- rnk_files[[i]]
      command <- paste("java  -Xmx1G -cp",gsea_jar,  "xtools.gsea.GseaPreranked -gmx",
                       dest_gmt_file, "-rnk" , rnk_file,
                       #"-cls",paste(working.dir,cls_filename,sep="/"),
                       "-collapse false -nperm 1000 -permute gene_set -scoring_scheme weighted -rpt_label",
                       analysis_name,"  -num 100 -plot_top_x 20 -rnd_seed 12345  -set_max 200 -set_min 15", 
                       "-zip_report false -out" ,gsea_working_path, "-gui false > ",
                       paste(gsea_working_path,"gsea_output.txt", sep="/"),sep=" ")
      system(command)
      
      # Clean up default directory
      tmp<-list.files(working_dir) # get list of files
      tmp<-tmp[file.info(tmp)$isdir==TRUE] # filter to just directories
      tmp<-tmp[nchar(tmp)==5] # check pattern
      tmp<-tmp[!is.na(tmp)] # remove na
      if(length(tmp)==1){
        if(nchar(tmp[1])==5){file.remove(paste(working_dir, tmp[1], sep="/")) }
      } 
    }
  }
  
  gsea_directories <- list.files(path = gsea_working_path, pattern = "\\.GseaPreranked")
  details = file.info(file.path(gsea_working_path, gsea_directories)) #get the details on the files
  details = details[with(details, order(as.POSIXct(mtime),decreasing = TRUE)), ]
  gsea_subdir_names <- gsub("(.*)/","", rev(row.names(details)[1:length(analysis_names)]))
  
  for (i in 1:length(analysis_names)){
    add_link <- paste("[ ",analysis_names[[i]], " ](", output_subdir,"/",gsea_working_dir,"/",gsea_subdir_names[i],"/index.html)", sep="");
    output_links <- paste(output_links, add_link, sep=" | " ); 
  }
  
  gsea_output_paths <- rev(row.names(details)[1:length(analysis_names)])
}) } 

if(enrichment_map && gsea_section & species!="Other" ){
  try({
  # Basic settings
  port.number = 1234
  base.url = paste("http://localhost:", toString(port.number), "/v1", sep="")
  #print(base.url)
  version.url = paste(base.url, "version", sep="/")
  cytoscape.open = TRUE
  tryCatch(expr = { GET(version.url)}, 
         error = function(e) { return (cytoscape.open = FALSE)},
         finally =function(r){ return(cytoscape.open = TRUE)})
  
  if(!cytoscape.open){
  #try and launch cytoscape
    print("Cytoscape is not open.  Please launch cytoscape.")
  } else{
    cytoscape.version =  GET(version.url)
    cy.version = fromJSON(rawToChar(cytoscape.version$content))
    print(cy.version)
  } 

  #defined threshold for GSEA enrichments (need to be strings for cyrest call)
  pvalue_gsea_threshold <- enrichmentmap_p_val
  qvalue_gsea_threshold <- enrichmentmap_q_val
  similarity_threshold <- "0.375"
  similarity_metric = "COMBINED"

  cur_model_name <- analysis_names[1]
  current_network_name <- paste(cur_model_name,pvalue_gsea_threshold,qvalue_gsea_threshold,sep="_")
  
  gsea_results_paths <- paste(gsea_output_paths,"edb",sep="/")
  gsea_results_filenames <- paste(gsea_results_paths,"results.edb",sep="/")

  # Although there is a gmt file in the gsea edb results directory it have been filtered to contain only genes represented in the expression set.  
  # If you use this fltered file you will get different pathway connectivity depending on the dataset being used.  
  # We recommend using original gmt file used for the gsea analysis and not the filtered one in the results directory.
  gmt_gsea_file <- paste(dest_gmt_file,sep="/")

  em_command = paste('enrichmentmap build analysisType="gsea" gmtFile=',gmt_gsea_file,
                   'pvalue=',pvalue_gsea_threshold, 'qvalue=',qvalue_gsea_threshold,
                   'similaritycutoff=',similarity_threshold,
                   'coefficients=',similarity_metric,
                   'ranksDataset1=',rnk_files[1],
                   'enrichmentsDataset1=',gsea_results_filenames[1], 'filterByExpressions=false',
                   'expressionDataset1=',file.path(working_dir,expression_file),
                   sep=" ")

  #enrichment map command will return the suid of newly created network.
  try({ response <- commandsGET(em_command) }, silent=TRUE);

  current_network_suid <- 0
  #enrichment map command will return the suid of newly created network unless it Failed.  If it failed it will contain the word failed
  tryCatch({
    if(length(response)>0){ #fix for not getting suid
      if(grepl(pattern="Failed", response)){
        paste(response)
      } else {
        current_network_suid <- response
        response <- renameNetwork(new.name = current_network_name, network = current_network_suid, base.url)
  
        output_network_file <- paste(gsea_working_path,"screenshot_network.pdf",sep="/")
        em_command2 = paste("view export OutputFile= ",output_network_file, " options=PDF", sep="")
        commandsRun(em_command2)
        em_command2 = paste("session save as file= ",paste(output_path,curr_model_name,sep="/"), sep="")
        commandsRun(em_command2)
      }
    }
  }, error=function(e){output_network_file=FALSE})
  
  }, silent=TRUE)
}

```
`r if(gsea_section & species!="Other" ){"Click below to view GSEA results:  "}`
`r if(gsea_section & species!="Other" ){ if(output_links != ""){ output_links }}`

`r if(enrichment_map & output_network_file!=FALSE){ "Click to view EnrichmentMap screen shot: \n"}`
`r if(enrichment_map & output_network_file!=FALSE){ paste(" | [ EnrichmentMap Image](",output_subdir,"/",gsea_working_dir,"/screenshot_network.pdf)", sep="") }`  
`r if(enrichment_map & output_network_file!=FALSE){ "If multiple contrasts, load GSEA results into Cytoscape/EnrichmentMap manually."}`


`r if( gsea_section & species!="Other" & metab_data==TRUE ){"### Mummichog Metabolite Enrichment"}`
```{r mummichog, eval=metab_data}

output_links <- "";

output_mummichog_subdir <- paste(output_subdir,"Mummichog", sep="/" )
output_mummichog_path <- file.path(working_dir, output_mummichog_subdir)
if( dir.exists(output_mummichog_path) == FALSE ) { dir.create(output_mummichog_path) }

suppressWarnings({ suppressMessages({
for(i in 1:length(omicsList)){
  if(omicsList[[i]][["dataFormat"]]=="Metabolites") {
    for (c in 1:(omicsList[[1]][["numCoef"]])){
      
      output_mummichog_subdir_tmp <- paste(output_mummichog_subdir,"/", omicsList[[i]][["dataType"]],"_", gsub("-","_",omicsList[[i]][["contrasts"]][c]), sep="" )
      output_mummichog_path_tmp <- file.path(working_dir, output_mummichog_subdir_tmp)
      if( dir.exists(output_mummichog_path_tmp) == FALSE ) { dir.create(output_mummichog_path_tmp) }
      
      setwd(output_mummichog_path_tmp)
      
      input_data <- na.omit(topTable(omicsList[[i]][["fit"]], adjust="BH", n=5000, sort.by='p', coef=c)[,c("mz", "P.Value", "t")] );
      colnames(input_data) <- c("m.z", "p.value", "t.score")
      output_filename <- file.path(output_mummichog_path,paste("mummichog_",omicsList[[i]][["dataType"]],"_",gsub("-","_",omicsList[[i]][["contrasts"]][c]),".txt", sep=""));
      write.table(x=input_data, file=output_filename, sep='\t',row.names=FALSE, col.names=TRUE, quote=FALSE)
      
      if( grepl("NEG", toupper(omicsList[[i]][["dataType"]])) ) { ion_mode<-"negative" } else { ion_mode<-"positive"}

      mSet <- InitDataObjects("mass_all", "mummichog", FALSE);
      mSet <- Read.PeakListData(mSet, output_filename);
      mSet <- UpdateMummichogParameters(mSet, "0.1", ion_mode, 0.05);
      mSet <- SanityCheckMummichogData(mSet);
      mSet <- PerformMummichog(mSet, "hsa_mfn", "fisher", "gamma");
      
      PreparePDFReport(mSet, usrName=paste(omicsList[[i]][["dataType"]], " ", omicsList[[i]][["contrasts"]][c], sep="" ))
      
      output_filename <- paste(omicsList[[i]][["dataType"]], " ", omicsList[[i]][["contrasts"]][c], sep="" )
      
      add_link <- paste("[ ",output_filename, " ](", output_mummichog_subdir_tmp,"/Analysis_Report.pdf)", sep="")
      output_links <- paste(output_links, add_link, sep=" | " )
    }
    output_links <- paste(output_links, add_link, sep="  \n" )
  }
}
}) })
    
setwd(working_dir);    
    
```
`r if(gsea_section & species!="Other" & metab_data==TRUE ){"Click below to view Mummichog results:  "}`
`r if(gsea_section & species!="Other" & metab_data==TRUE ){ if(output_links != ""){ output_links }}`


`r if(metab_data==TRUE ){"### Get and Save Metabolite Annotation"}`
```{r hmdbQuery, eval=metab_data}

output_links <- "";





    
```
`r if(metab_data==TRUE ){"Click below to view metabolite annotation info:  "}`
`r if(metab_data==TRUE ){ if(output_links != ""){ output_links }}`





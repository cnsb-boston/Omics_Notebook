# QC and Exploratory Proteomics Analysis

`r if(txtFolder){"### Raw Data QC Report (PTXQC)"}`
```{r PTX_QC_report, results='hide', message=FALSE, warning=FALSE}
# if txt folder provided, generate PTXQC report
tryCatch(expr={
if(txtFolder && !newcontrastonly){
  library(PTXQC)
  require(methods)
  library(data.table)

  txt_folder <- file.path(working_dir, "txt");
  report.mq <- createReport(txt_folder);
}
}, error=function(e){print("Error generating PTXQC report")} )
```
`r if(txtFolder){"[ View Raw Data QC Report (PTXQC) ](txt/report_v0.92.3_MQ_pipeline.pdf)" }` 

---

### Normalization: Boxplot and Distribution
```{r boxplots_QC_and_norm, message=FALSE, warning=FALSE, fig.width=12, fig.height=4}
if(!newcontrastonly){
  for(i in 1:length(omicsList)){
    omicsList[[i]][[5]] <- QCandNorm(eset=omicsList[[i]][[5]], type=omicsList[[i]][[1]], norm=norm_method)
  }
}

output_links <- "";
output_links <- paste("[ ",omicsList[[1]][["dataType"]], " ](", output_plots_subdir,"/boxplot_histogram_",omicsList[[1]][["dataType"]],".pdf)", sep="")
if(length(omicsList)>1) { for (i in 2:length(omicsList)){
  add_link <- paste("[ ",omicsList[[i]][["dataType"]], " ](", output_plots_subdir,"/boxplot_histogram_",omicsList[[i]][["dataType"]],".pdf)", sep="")
  output_links <- paste(output_links, add_link, sep=" | " )
} }

```
Click to view full size images: `r if(output_links != ""){ output_links }`  

---

### PCA Plots
```{r PCA_plots, results='hide', fig.keep='all', fig.width=12, fig.height=4}

for(i in 1:length(omicsList)){
  plot.pca(eset=omicsList[[i]][["eSet"]], type=omicsList[[i]][["dataType"]])
}

output_links <- "";
output_links <- paste("[ ",omicsList[[1]][["dataType"]], " ](", output_plots_subdir,"/PCAplots_",omicsList[[1]][["dataType"]],".pdf)", sep="")
if(length(omicsList)>1) { for (i in 2:length(omicsList)){
  add_link <- paste("[ ",omicsList[[i]][["dataType"]], " ](", output_plots_subdir,"/PCAplots_",omicsList[[i]][["dataType"]],".pdf)", sep="")
  output_links <- paste(output_links, add_link, sep=" | " )
} }

```
Click to view full size images: `r if(output_links != ""){ output_links }`  

---

`r if(length(omicsList)>1){"### Venn Diagram"}`
```{r venn, message=FALSE, fig.width=4, fig.height=3, eval= (length(omicsList)>1) }

hit_list <- vector("list", length(omicsList))

for(i in 1:length(omicsList)){
  hit_list[[i]] <- fData(omicsList[[i]][["eSet"]])$Gene
  names(hit_list)[i] <-omicsList[[i]][["dataType"]]
}

fill_col <- rainbow(length(omicsList))
futile.logger::flog.threshold(ERROR);
venn <- venn.diagram( x=hit_list, filename=NULL, height=2000, width=2000, 
                      cat.default.pos="outer", fill=fill_col,main="Overlap" );
output_filename <- file.path(output_plots_path, "VennDiagram.pdf");
pdf(output_filename);
grid.draw(venn);
tmp<-dev.off();
grid.draw(venn);

```

---

### Variation Plots, Filtering
```{r variation, message=FALSE, warning=FALSE}

if(!newcontrastonly){
  for(i in 1:length(omicsList)){
    omicsList[[i]][[6]] <- variationPlotFilter(eset=omicsList[[i]][["eSet"]], type=omicsList[[i]][["dataType"]]);
    names(omicsList[[i]])[6] <- "topVariableMatrix";
  }
}

output_links <- "";
output_links <- paste("[ ",omicsList[[1]][["dataType"]], "-Variation ](", output_plots_subdir,"/variation_",omicsList[[1]][["dataType"]],".pdf) | ",
                      "[ ",omicsList[[1]][["dataType"]], "-Pairs ](", output_plots_subdir,"/variation_",omicsList[[1]][["dataType"]],".jpeg)", sep="")
if(length(omicsList)>1) { for (i in 2:length(omicsList)){
  add_link <- paste("[ ",omicsList[[i]][["dataType"]], "-Variation ](", output_plots_subdir,"/variation_",omicsList[[i]][["dataType"]],".pdf) | ",
                      "[ ",omicsList[[i]][["dataType"]], "-Pairs ](", output_plots_subdir,"/variation_",omicsList[[i]][["dataType"]],".jpeg)", sep="")
  output_links <- paste(output_links, add_link, sep="  \n" )
} }
  
```
Click below to view SD vs Mean and Pairs plots:  
`r if(output_links != ""){ output_links }`  

---

### Global Static Heatmaps
```{r heatmaps_qc, message=FALSE}

if(!newcontrastonly){
  for(i in 1:length(omicsList)){
    drawthemaps(eset=omicsList[[i]][["eSet"]], emat_top=omicsList[[i]][["topVariableMatrix"]], type=omicsList[[i]][["dataType"]]);
  }
}

output_links <- "";
output_links <- paste("[ ",omicsList[[1]][["dataType"]], " ](", output_plots_subdir,"/heatmaps_",omicsList[[1]][["dataType"]],".pdf)", sep="")
if(length(omicsList)>1) { for (i in 2:length(omicsList)){
  add_link <- paste("[ ",omicsList[[i]][["dataType"]], " ](", output_plots_subdir,"/heatmaps_",omicsList[[i]][["dataType"]],".pdf)", sep="")
  output_links <- paste(output_links, add_link, sep=" | " )
} }

```
Click to view static heatmaps plots: `r if(output_links != ""){ output_links }`  

---

### Interactive Heatmap
```{r interactive_plots_qc, warning=FALSE, message=FALSE}

if(!newcontrastonly){
  for(i in 1:length(omicsList)){
    makeInteractiveHM(eset=omicsList[[i]][["eSet"]], type=omicsList[[i]][["dataType"]]);
  }
}

output_links <- "";
output_links <- paste("[ ",omicsList[[1]][["dataType"]], "-All ](", output_plots_subdir,"/heatmap_all_",omicsList[[1]][["dataType"]],".html)", sep="")
if(length(omicsList)>1) { for (i in 2:length(omicsList)){
  add_link <- paste("[ ",omicsList[[i]][["dataType"]], "-All ](", output_plots_subdir,"/heatmap_all_",omicsList[[i]][["dataType"]],".html)", sep="")
  output_links <- paste(output_links, add_link, sep=" | " )
} }

```

Click to view interactive heatmaps: `r if(output_links != ""){ output_links }`  

---

### Save Data
```{r save_data_qc, message=FALSE }

# save for omics integrator, expression matrix, expression set RDS, ranked list for GSEA

if(!newcontrastonly){
  for(i in 1:length(omicsList)){
    saveTheFiles(eset=omicsList[[i]][["eSet"]], type=omicsList[[i]][["dataType"]]);
  }
}  

if(newcontrastonly==FALSE && runDifferential==FALSE && saveXlsx==TRUE){   
  
  wbOut <- createWorkbook()
  
  for(i in 1:length(omicsList)){
    writeDataToSheets(wb=wbOut, eset=omicsList[[i]][["eSet"]], type=omicsList[[i]][["dataType"]]);
  } 
  
  output_filename=file.path(output_path, paste(project_name, "_Summary.xlsx", sep=""))
  saveWorkbook(wbOut, file=output_filename, overwrite=TRUE)
}

``` 

---



# QC and Exploratory Proteomics Analysis

`r if(!iserror && txtFolder){"## Raw Data QC Report (PTXQC)"}`
```{r PTX_QC_report, results='hide', message=FALSE, warning=FALSE}
# if txt folder provided, generate PTXQC report
tryCatch(expr={
if(txtFolder && !newcontrastonly){
  library(PTXQC)
  require(methods)
  library(data.table)

  txt_folder <- file.path(working_dir, "txt");
  report.mq <- createReport(txt_folder);
}
}, error=function(e){print("Error generating PTXQC report")} )
```
`r if(!iserror){if(txtFolder){"[ View Raw Data QC Report (PTXQC) ](txt/report_v0.92.3_MQ_pipeline.pdf)" }}` 

---

## Normalization and QC Visualization
#### Normalization: Boxplot and Distribution
```{r boxplots_QC_and_norm, message=FALSE, warning=FALSE, fig.width=12, fig.height=4}
tryCatch( expr={
if(!newcontrastonly){
  QCandNorm <- function(eset, norm, type='proteo', outputpath=output_plots_path,
                        annotate=annot, lookup=look_up){
    
    col_palette <- rainbow(length(levels(pData(eset)$Group)))
    annotCol <- col_palette[pData(eset)$Group]
  
    eset_matrix <- exprs(eset)
    df <- data.frame(reshape2::melt(eset_matrix, id.vars = NULL));
    plot1 <- ggplot(df, aes(x = Var2, y = value)) + geom_boxplot(fill=annotCol) +
      theme(axis.text.x=element_text(angle=45, hjust=1)) + 
      labs(title=paste(lookup[type], " log2 Intensity: Before Normalization", sep=''));
    plot2 <- ggplot(df, aes(x=value, colour=Var2)) + geom_density()+ 
      labs(title=paste(lookup[type], " log2 Intensity: Before Normalization", sep=''));
    
    if(norm=='quantile'){
      eset_matrix_norm <- as.matrix(normalize.quantiles(eset_matrix))
      dimnames(eset_matrix_norm) <- dimnames(eset_matrix)
    }
    else if (norm=='loess'){
      eset_matrix_norm <- as.matrix(normalizeCyclicLoess(eset_matrix, method='pairs'))
    }
    else {  eset_matrix_norm<-eset_matrix }
  
    df <- data.frame(reshape2::melt(eset_matrix_norm, id.vars = NULL));
    plot3 <- ggplot(df, aes(x = Var2, y = value)) + geom_boxplot(fill=annotCol) +
      theme(axis.text.x=element_text(angle=45, hjust=1)) + 
      labs(title=paste(lookup[type], " log2 Intensity: After ",
                       toupper(norm)," Normalization", sep=''));
    plot4 <- ggplot(df, aes(x=value, colour=Var2)) + geom_density()+ 
      labs(title=paste(lookup[type], " log2 Intensity: After ",
                       toupper(norm)," Normalization", sep=''));
    
    output_filename<-file.path(outputpath, paste("boxplot_histogram_",type,".pdf", sep=''));
    pdf(output_filename);
    print(plot1);
    print(plot3);
    print(plot2);
    print(plot4);
    dev.off();
  
    grid.arrange(plot1+labs(title="Raw Data"), plot3+labs(title="Normalized"),
                 plot2+theme(legend.position="none")+labs(title="Raw Data"), 
                 plot4+theme(legend.position="none")+labs(title="Normalized"),
                 top=paste(lookup[type], ":", sep=""), ncol=4);

    output_filename<-file.path(outputpath, paste("MAplots_",type,".pdf", sep=''))
    pdf(output.filename)
    for (i in 1:ncol(eset)) {
      limma::plotMA(eset_matrix, array=i, main=paste(lookup[type], "MA Plot",i,sep=" "))
      limma::plotMA(eset_matrix_norm, array=i, 
                    main=paste(lookup[type],toupper(norm),"Normalized MA Plot",i,sep=" "))
    }
    dev.off();
  
    mn <- apply(eset_matrix_norm, 1, median);
    rle <- data.frame(sweep(eset_matrix_norm, MARGIN=1, STATS=mn, FUN='-'));
    output_filename <- file.path(outputpath, paste("RLE_",type,".pdf", sep=''));
    pdf(output_filename, width=11, height=8.5);
    par(mar=c(10,4,4,2)+0.1)
    boxplot(rle, main="RLE (Relative Log Expression)\nShould be centered on 0 (blue line)",
        names=colnames(eset_matrix_norm), las=2)
    lines(x=c(0,ncol(eset_matrix_norm)+1), y=rep(0,2), col="blue", lty=2)
    lines(x=c(0,ncol(eset_matrix_norm)+1), y=rep(0.1,2), col="red", lty=2)
    par(mar=c(5,4,4,2)+0.1)
    dev.off();
  
    eset_norm <- ExpressionSet(assayData=eset_matrix_norm);
    pData(eset_norm) <- pData(eset);
    rownames(pData(eset_norm)) <- colnames(eset_matrix_norm);
    fData(eset_norm) <- fData(eset);
  
    return (eset_norm);
  }

  if(isthereProteo) {eset_global <- QCandNorm(eset_global, norm=norm_method)}
  
  if(istherePhospho) {eset_phospho <- QCandNorm(eset_phospho, norm=norm_method, type="phospho")}
}
}, error=function(e){iserror=TRUE; print("Error performing normalization");} )
```
Click below to view full size images: 
`r if(!iserror){if(isthereProteo){paste("[  Proteomic  ](",output_plots_path,"/boxplot_histogram_proteo.pdf)", sep="") }}` 
`r if(!iserror){if(istherePhospho){paste("[  Phosphoproteomic  ](",output_plots_path,"/boxplot_histogram_phospho.pdf)", sep="") }}`

---

## PCA Plots
```{r PCA_plots, results='hide', fig.keep='all', fig.width=12, fig.height=4}
tryCatch(expr={
if(!newcontrastonly){
  # Set up annotation colors
  col_palette <- rainbow(length(levels(annot$Group)))
  annotCol <- col_palette[annot$Group]

  # plot pca function (edit as needed)
  plot.pca <- function(PC_data, x_axis="PC1", y_axis="PC2", mlab="") {
    par(xpd=T, mar=par()$mar+c(0,0,0,7))
    pca_graph <- plot(x=PC_data$x[,x_axis], y=PC_data$x[,y_axis], pch=19, cex=1, 
                      col=annotCol,
                      xlim=(1.2*range(PC_data$x[,x_axis])), ylim=1.2*range(PC_data$x[,y_axis]),
                      xlab=paste(x_axis, sprintf(" (%2.0f%%)", percent.variance[x_axis]), sep=""), 
                      ylab=paste(y_axis, sprintf(" (%2.0f%%)", percent.variance[y_axis]), sep=""),
                      main=mlab)
    text(x=PC_data$x[,x_axis], y=PC_data$x[,y_axis], rownames(PC_data$x), cex=0.8, col="grey")
    legend("topright", inset=c(-0.4, 0), pch=20, col=col_palette, legend=levels(annot$Group))
    par(mar=c(5,4,4,2)+0.1)
    return (pca_graph)
    }
    # plot pca loadings function (edit as needed)
  plot.pca.loading <- function(PC_data, x_axis="PC1", y_axis="PC2", mlab="") {
    pca_graph <- plot(x=PC_data$rotation[,x_axis], y=PC_data$rotation[,y_axis], pch=1, cex=0,col="grey",
                      xlim=(1.2*range(PC_data$rotation[,x_axis])), ylim=1.2*range(PC_data$rotation[,y_axis]),
                      xlab=paste(x_axis, sep=""), ylab=paste(y_axis, sep=""),main=mlab)
    text(x=PC_data$rotation[,x_axis], y=PC_data$rotation[,y_axis], rownames(PC_data$rotation), cex=0.7)
    return (pca.graph)
    }
  
  if(isthereProteo) {
    PC_global <- prcomp(t(exprs(eset_global)))
    percent_variance <- summary(PC_global)$importance["Proportion of Variance",]*100
    summary(PC_global)
    output_filename<-file.path(output_plots_path, "PCAplots_proteo.pdf")
    pdf(output_filename)
    invisible(plot.pca(PC_global, mlab="Principal Component Analysis \nAcross All Features in All Samples - Global"))
    invisible(plot.pca.loading(PC_global, mlab="Principal Component Factor Loadings \nAcross All Features in All Samples - Global"))
    plot(PC_global, type = 'l', main="Variances vs. Principal Components - Global")
    tmp<-dev.off()
  }

  if(istherePhospho) {
    PC_phospho <- prcomp(t(exprs(eset_phospho)))
    percent_variance <- summary(PC_phospho)$importance["Proportion of Variance",]*100
    summary(PC_phospho)
    output_filename<-file.path(output_plots_path, "PCAplots_phospho.pdf")
    pdf(output_filename)
    invisible(plot.pca(PC_phospho, mlab="Principal Component Analysis \nAcross All Features in All Samples - Phospho"))
    invisible(plot.pca.loading(PC_phospho, mlab="Principal Component Factor Loadings \nAcross All Features in All Samples - Phospho"))
    print(plot(PC_phospho, type = 'l', main="Variances vs. Principal Components - Phospho"))
    tmp<-dev.off()
  }

  par(mfcol=c(1,2))
  if(isthereProteo && !istherePhospho){
    plot.pca(PC_global, mlab="Principal Component Analysis \nAcross All Features in All Samples - Global") }
  if(!isthereProteo && istherePhospho){
    plot.pca(PC_phospho, mlab="Principal Component Analysis \nAcross All Features in All Samples - Phospho") }
  if(isthereProteo && istherePhospho){
    plot.pca(PC_global, mlab="Principal Component Analysis \nAcross All Features in All Samples - Global")
    plot.pca(PC_phospho, mlab="Principal Component Analysis \nAcross All Features in All Samples - Phospho")
    }
  par(mfcol=c(1,1))
}
}, error=function(e){iserror=TRUE; print("Error generating PCA plots");} )
```
Click below to view full size images:
`r if(!iserror){if(isthereProteo){paste("[  Proteomic  ](",output_plots_path,"/PCAplots_proteo.pdf)", sep="") }}`
`r if(!iserror){if(istherePhospho){paste("[  Phosphoproteomic  ](",output_plots_path,"/PCAplots_phospho.pdf)", sep="") }}`  

---

#### Venn Diagram
```{r venn, message=FALSE, fig.width=4, fig.height=3}
tryCatch( expr={
if(isthereProteo && istherePhospho){
  hit_list <- list(Proteins=fData(eset_global)$Gene, 
                   Phosphoproteins=fData(eset_phospho)$Gene )
  fill_col <- c('green', 'blue')
  size <- rep(1,2)
  futile.logger::flog.threshold(ERROR);
  venn <- venn.diagram( x=hit_list, filename=NULL, height=2000, width=2000, 
                        fill=fill_col, cat.default.pos="outer", cat.cex=size,
                        main="Overlap of Proteins and Phosphoproteins",
                        cat.pos=c(180,180 ));
  output_filename <- file.path(output_path, "VennDiagram.pdf");
  pdf(output_filename);
  grid.draw(venn);
  tmp<-dev.off();
  grid.draw(venn);
}
}, error=function(e){iserror=TRUE; print("Error generating venn diagram");} )
```

---

#### Variation Plots, Filtering
```{r variation, message=FALSE, warning=FALSE}
tryCatch(expr={
if(!newcontrastonly){
  variationPlotFilter <- function(eset, type="proteo", outputpath=output_plots_path, 
                                  percent_choice=0.1) {
    emat<-exprs(eset)
    MEAN <- apply(emat, 1, mean)
    STDEV <- apply(emat, 1, sd)
    MAD <- apply(emat, 1, mad)
    MED <- apply(emat, 1, median)
    top_hits <- names(MAD)[order(MAD, decreasing=TRUE)[1:(percent_choice*length(MAD))]]
    emat_top <- emat[top_hits[top_hits!=""],]
  
    output_filename<-file.path(outputpath, paste("variation_",type,".pdf", sep=""))
    pdf(output_filename)
    plot(MEAN, STDEV, pch=".", cex=4, main=paste("mean vs. stdev: ", type, sep=""))
    plot(MED, MAD, pch=19, cex=0.5, log="", main=paste("median vs MAD: ",type, sep=""))
    points(MED[top_hits], MAD[top_hits], pch=19, cex=0.5, col="red")
    legend("topright", pch=20, col=c("black", "red"), legend=c("all points", "filtered top 10%"))
    dev.off()
    
    output_filename<-file.path(outputpath, paste("variation_",type,".jpeg", sep=""))
    jpeg(output_filename)
    pairs(emat, pch=".")
    dev.off()
    return (emat_top)
   }

  if(isthereProteo) { emat_global_top <- variationPlotFilter(eset_global) }

  if(istherePhospho) { emat_phospho_top <- variationPlotFilter(eset_phospho, type="phospho") }
  
}}, error=function(e){iserror=TRUE; print("Error generating variation plots");} )
```
Click below to view SD vs Mean plots: | 
`r if(!iserror){if(isthereProteo){paste("[  Proteomic  ](",output_plots_path,"/variation_proteo.pdf)", sep="") }}` | 
`r if(!iserror){if(istherePhospho){paste("[  Phosphoproteomic  ](",output_plots_path,"/variation_phospho.pdf)", sep="") }}`  
Click below to view Pairs plots: | 
`r if(!iserror){if(isthereProteo){paste("[  Proteomic  ](",output_plots_path,"/variation_proteo.jpeg)", sep="") }}` | 
`r if(!iserror){if(istherePhospho){paste("[  Phosphoproteomic  ](",output_plots_path,"/variation_phospho.jpeg)", sep="") }}`  

---

## Global Static Heatmaps
```{r heatmaps_qc, message=FALSE}
tryCatch(expr={
if(!newcontrastonly){
  drawthemaps <- function(eset, emat_top, type='proteo', outputpath=output_plots_path,
                        mapcolor=map_color, lookup=look_up){
  
    annotLab <- data.frame(Group = factor(pData(eset)$Group));
    annotCol <- list(Group = rainbow(length(levels(pData(eset)$Group))))
  
    if(mapcolor=="viridis"){mapcolor <- viridis(11); maponeway <- viridis(11);
    } else {mapcolor <- (rev(brewer.pal(11, mapcolor)));
            maponeway <- rev(brewer.pal(9, "Blues")) }
  
    output_filename <- file.path(outputpath, paste("heatmaps_",type,".png", sep=''));
    png(output_filename);
    # all features, z-score
    emat_sel <- t(scale(t(exprs(eset)))) # Z-score across rows
    emat_sel[emat_sel < -2] <- -2
    emat_sel[emat_sel > 2] <- 2
    aheatmap(emat_sel, Rowv=TRUE, Colv=TRUE, annCol=annotLab, annColors = annotCol,
             labCol=colnames(emat_sel),labRow=rownames(emat_sel),scale="none",  color=mapcolor,
             main=paste(lookup[type], ": All features, row z score", sep='')); 
  
    # all features, log2 intensity
    emat_sel <- exprs(eset)
    aheatmap(emat.sel, Rowv=TRUE, Colv=TRUE, annCol=annotLab, annColors = annotCol,
             labCol=colnames(emat_sel),labRow=rownames(emat_sel), scale="none", color=maponeway,
             main=paste(lookup[type], ": All proteins, log2 Intensity", sep='')) 

    # variation filter, z score
    emat_sel <- emat_top
    emat_sel <- t(scale(t(emat_sel))) # Z-score across rows
    emat_sel[emat_sel < -2] <- -2
    emat_sel[emat_sel > 2] <- 2
    aheatmap(emat_sel, Rowv=TRUE, Colv=TRUE, annCol=annotLab, annColors = annotCol,
            labCol=colnames(emat_sel),labRow=rownames(emat_sel),scale="none",  color=mapcolor,
            main=paste(lookup[type], ": Highest variation, row z score", sep='')); 
    tmp<-dev.off();
  }

  if(isthereProteo){ drawthemaps(eset=eset_global,emat_top=emat_global_top) }
  if(istherePhospho){ drawthemaps(eset=eset_phospho,emat_top=emat_phospho_top, type='phospho') }

}}, error=function(e){iserror=TRUE; print("Error generating static heatmaps");} )
```
Click below to view static heatmaps plots:  
`r if(!iserror){if(isthereProteo){ paste("[  Proteomic - All  ](",output_plots_path,"/heatmaps_proteo.png)", sep="") }}`  
`r if(!iserror){if(istherePhospho){ paste("[  Phosphoproteomic - All ](",output_plots_path,"/heatmaps_phospho.png)", sep="") }}`  

---

## Interactive Heatmap
```{r interactive_plots_qc, warning=FALSE, message=FALSE}
tryCatch( expr= {
if(!newcontrast){
  makeInteractiveHM <- function(eset, type="proteo", outputpath=output_plots_path,mapcolor=map_color ){
  
  annotCol <- c("red", "green", "blue", "yellow", "green", "purple",
                "brown", "black", "grey", "orange", "white", "light green", 
                "pink", "light blue" );
  sampleCols <- annotCol[1:length(levels(pData(eset)$Group))][pData(eset)$Group];
  
  if(mapcolor=="viridis"){mapcolor <- viridis(11)
  } else {mapcolor <- colorRampPalette(rev(brewer.pal(11, mapcolor))) }

#   output.filename <- file.path(outputcontrastpath, paste("heatmap_diff_",type,".html", sep=''));
#   emat.sel <- exprs(eset[rownames(eset) %in% rownames(limmaSig),])
#   emat.sel <- t(scale(t(emat.sel))) # Z-score across rows
#   emat.sel[emat.sel < -2] <- -2
#   emat.sel[emat.sel > 2] <- 2
#   heatmaply(emat.sel, scale='none', margins=c(100,100,40,20),
#             col_side_colors=pData(eset)$Group,
#             colors=mapcolor,file=output.filename );
    output_filename <- file.path(outputpath, paste("heatmap_all_",type,".html", sep=''));
    emat_sel <- exprs(eset)
    emat_sel <- t(scale(t(emat_sel))) # Z-score across rows
    emat_sel[emat_sel < -2] <- -2
    emat_sel[emat_sel > 2] <- 2
    tmp<-heatmaply(emat_sel, scale='none', margins=c(100,100,40,20),
              col_side_colors=pData(eset)$Group,
              colors=mapcolor,file=output_filename );
    rm(tmp)
  }
  
  if(isthereProteo){ makeInteractiveHM(eset=eset_global) }

  if(istherePhospho){ makeInteractiveHM(eset=eset_phospho, type="phospho") }

}}, error=function(e){iserror=TRUE; print("Error generating interactive plots");} )

```

Click below to view interactive plots:  
Heatmaps:  
`r if(!iserror){if(isthereProteo){paste("[  Proteomic-All  ](",output_plots_path,"/heatmap_all_proteo.html)", sep="") }}` | 
`r if(!iserror){if(istherePhospho){paste("[  Phosphoroteomic-All  ](",output_plots_path,"/heatmap_all_phospho.html)", sep="") }}`  

---

## Save Data
```{r save_data_qc, message=FALSE }
tryCatch( expr={
# save for omics integrator, expression matrix, expression set RDS, ranked list for GSEA
saveTheFiles <- function(eset, type='proteo', outputpath=output_files_path, workingdir=working.dir,
                         saveTheEset=!newcontrastonly){
    if(saveTheEset){
      output_filename <- file.path(outputpath, paste("Data_eset_",type,".RDS", sep=""));             
      saveRDS(eset, file=output_filename) }

      output_filename <- file.path(outputpath,paste("Expression_matrix_",type,".txt", sep=''));
      write.table(x=cbind(fData(eset)[,c("Gene", "Protein.names")], exprs(eset)), 
            file=output_filename, sep='\t',row.names=FALSE, col.names=TRUE, quote=FALSE);
    }
}

if(isthereProteo){ saveTheFiles(eset_global); }

if(istherePhospho){ saveTheFiles(eset_phospho); }



if(runDifferential==FALSE){   
  
  wb <- createWorkbook()
  
  if(map_color=="viridis"){mapcolor <- viridis(11)
  } else {mapcolor <- colorRampPalette(rev(brewer.pal(11, map_color))) }
  
  if(isthereProteo){
    sheet_proteo <- createSheet(wb, "Proteomics")
    fomatted_table_global <- cbind(fData(eset_global)[,c("Gene", "Protein.names", "Uniprot")],
                                 exprs(eset_global),
                                 fData(eset_global)[,c("Uniprot_Function", "Uniprot_Cellular_Location", "Uniprot_Disease",
                                                    "GO_biological_process", "GO_molecular_function", "GO_cellular_component",
                                                    "ReactomeID", "KEGG_ID", "Gene.names", "Protein.IDs")])
    colnames(formatted_table_global) <- c("Gene", "Protein", "Uniprot", colnames(eset_global), "Function", "Cellular_Localization", "Disease",
                                     "GO_biological_process", "GO_moolecular_function", "GO_cellular_component", "ReactomeID", "KEGG_ID",
                                     "Gene_names", "Protein_IDs")
    # set formatted table to excel sheet
    emat_sel <- exprs(eset_global)
    emat_sel <- t(scale(t(emat_sel))) # Z-score across rows
    emat_sel[emat_sel < -2] <- -2
    emat_sel[emat_sel > 2] <- 2
    zScale <- seq(min(emat_sel), max(emat_sel), 11)
    findNearestColor <- function(x, zScale=zScale, mapcolor=mapcolor) {
      colorIndex <- which(abs(zScale-x)==min(abs(zScale-x)))
      return(mapcolor[colorIndex])
    }
    
    # nested for loop, rows/columns, to fill background color
    for (r in 2:nrow(emat_sel)+1){
      for (c in 4:ncol(emat_sel)+3){
        
      }
    }
      
    
    #for differential, add FDR, log FC, sorted by log FC, add conditional format color bar column
    
    # bold top row, lock first row, first column, top column height, sample name rotate 90
    
    
  }
  if(istherePhospho){
    sheet_phospho <- createSheet(wb, "Phospho-proteomics")
    fomatted_table_phospho <- cbind(fData(eset_phospho)[,c("Gene", "Protein.names", "Uniprot")],
                              exprs(eset_phospho),
                              fData(eset_phospho)[,c("Uniprot_Function", "Uniprot_Cellular_Location", "Uniprot_Disease",
                                                    "GO_biological_process", "GO_molecular_function", "GO_cellular_component",
                                                    "ReactomeID", "KEGG_ID", "Gene.names", "Protein.IDs")])
    colnames(formatted_table_phospho) <- c("Gene", "Protein", "Uniprot", colnames(eset_phospho), "Function", "Cellular_Localization", "Disease",
                                     "GO_biological_process", "GO_moolecular_function", "GO_cellular_component", "ReactomeID", "KEGG_ID",
                                     "Gene_names", "Protein_IDs")   
    
  }
  
  
  output_filename <- file.path(output_path, paste("Summary_", project_name, ".xlsx", sep=""))
  saveWorkbook(wb, output_filename)
##########    



}, error=function(e){iserror=TRUE; print("Error saving data");} )
```
Click below to view expression matrix:
`r if(!iserror){if(isthereProteo){paste("[  Proteomic  ](",output_files_path,"/Expression_matrix_proteo.txt)", sep="") }}`
`r if(!iserror){if(istherePhospho){paste("[  Phosphoproteomic  ]("output_files_path,"/Expression_matrix_phospho.txt)", sep="") }}`  

---



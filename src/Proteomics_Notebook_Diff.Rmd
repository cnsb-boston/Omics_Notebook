# Differential Analysis `r contrastgroups[2]` - `r contrastgroups[1]`  

### Limma
```{r }
#limma
for(i in 1:length(omicsList)){

  TS <- factor(pData(omicsList[[i]][["eSet"]])$Group); #paste(pData(eset)Group, pData(eset1)$Disease, sep='.'))
  design <- model.matrix(~ 0 + TS);
  colnames(design) <- make.names(levels(TS));
  fit1 <- lmFit( omicsList[[i]][["eSet"]], design);
  
  if(contrastgroups[2]=="Others"){ contrast_matrix <- makeContrasts(contrastgroups[2], levels=design);
  } else { contrast_matrix <- makeContrasts(paste(contrastgroups[2],'-',contrastgroups[1], sep=''), levels=design); }
  
  fit1 <- contrasts.fit(fit1, contrast_matrix);
  omicsList[[i]][[7]] <- eBayes(fit1);
  names(omicsList[[i]])[7] <- "fit";

  omicsList[[i]][[8]] <- topTable(omicsList[[i]][["fit"]], coef=1, adjust.method="BH", n=Inf, sort.by = 'p');
  names(omicsList[[i]])[8] <- "limmaRes";
  
  
  omicsList[[i]][[9]] <- subset(omicsList[[i]][["limmaRes"]], adj.P.Val < adjpcutoff);
  names(omicsList[[i]])[9] <- "limmaRes_sig";

  print(paste(omicsList[[i]][["dataType"]],": ", nrow(omicsList[[i]][["limmaRes_sig"]]), " features with differential intensities at an FDR less than ", adjpcutoff,".", sep="") );
  print(paste("The top 10th percentile of differenital freature intensities has an FDR of ", 
              omicsList[[i]][["limmaRes"]][0.1*nrow(omicsList[[i]][["limmaRes"]]),]$adj.P.Val,".", sep="") );
  
  if( nrow(omicsList[[i]][["limmaRes_sig"]]) < 100) { omicsList[[i]][["limmaRes_sig"]] <- omicsList[[i]][["limmaRes"]][1:(0.1*nrow(omicsList[[i]][["limmaRes"]])),] }
  
  omicsList[[i]][[10]] <- decideTests(omicsList[[i]][["fit"]]);
  names(omicsList[[i]])[10] <- "dt";
  summary(omicsList[[i]][["dt"]])
  
}

output_contrast_subdir <- paste(output_subdir,gsub("\\.","",paste(contrastgroups[2],contrastgroups[1], sep="_")), sep="/" )
output_contrast_path <- file.path(working_dir, output_contrast_subdir)
if( dir.exists(output_contrast_path) == FALSE ) { dir.create(output_contrast_path) }

#carat

```

---

### Volcano plots
```{r, message=FALSE, fig.width=4, fig.height=3}

for(i in 1:length(omicsList)){
  makeVolcano(omicsList[[i]][["limmaRes"]], dt=omicsList[[i]][["dt"]], type=omicsList[[i]][["dataType"]]);
}

output_links <- "";
output_links <- paste("[ ",omicsList[[1]][["dataType"]], " ](", output_contrast_subdir,"/volcano_",omicsList[[1]][["dataType"]],".pdf)", sep="")
if(length(omicsList)>1) { for (i in 2:length(omicsList)){
  add_link <- paste("[ ",omicsList[[i]][["dataType"]], " ](", output_contrast_subdir,"/volcano",omicsList[[i]][["dataType"]],".pdf)", sep="")
  output_links <- paste(output_links, add_link, sep=" | " )
} }

```
Click to view static volcano plots: `r if(output_links != ""){ output_links }`  

---

### Differential Static Heatmaps
```{r, message=FALSE}

for(i in 1:length(omicsList)){
  drawthemapsDiff(eset=omicsList[[i]][["eSet"]], dt=omicsList[[i]][["dt"]], limmaSig=omicsList[[i]][["limmaRes"]], type=omicsList[[i]][["dataType"]])
}

output_links <- "";
output_links <- paste("[ ",omicsList[[1]][["dataType"]], "-Differential ](", output_contrast_subdir,"/heatmaps_",omicsList[[1]][["dataType"]],".pdf)", sep="")
if(length(omicsList)>1) { for (i in 2:length(omicsList)){
  add_link <- paste("[ ",omicsList[[i]][["dataType"]], "-Differential ](", output_contrast_subdir,"/heatmaps_",omicsList[[i]][["dataType"]],".pdf)", sep="")
  output_links <- paste(output_links, add_link, sep=" | " )
} }

```
Click to view static heatmap plots: `r if(output_links != ""){ output_links }`   


---

### Interactive Volcano Plots
```{r, warning=FALSE, message=FALSE}

for(i in 1:length(omicsList)){
  makeInteractiveV(eset=omicsList[[i]][["eSet"]], fit=omicsList[[i]][["fit"]], dt=omicsList[[i]][["dt"]],
                   limmaSig=omicsList[[i]][["limmaRes"]], type=omicsList[[i]][["dataType"]]);
}

output_links <- "";
output_links <- paste("[ ",omicsList[[1]][["dataType"]], " ](", output_contrast_subdir,"/InteractivePlots/Volcano-Plot_",omicsList[[1]][["dataType"]],".html)", sep="")
if(length(omicsList)>1) { for (i in 2:length(omicsList)){
  add_link <- paste("[ ",omicsList[[i]][["dataType"]], " ](", output_contrast_subdir,"/InteractivePlots/Volcano-Plot_",omicsList[[i]][["dataType"]],".html)", sep="")
  output_links <- paste(output_links, add_link, sep=" | " )
} }

```
Click to view interactive Volcano plots: `r if(output_links != ""){ output_links }`   


---

## Enrichment
`r if(enrichr_section){"### EnrichR"}`
```{r, message=FALSE, results='hide' }
# enrichR, save GSEA ranked list, eventually add run GSEA

output_links <- "";
if(enrichr_section==TRUE){

  for(i in 1:length(omicsList)){
    runEnrichR(omicsList[[i]][["limmaRes_sig"]][, c("Gene", "logFC") ], type=omicsList[[i]][["dataType"]]) 
  }
  
  if(length(omicsList)>1){
    
    gene_table <- omicsList[[1]][["limmaRes_sig"]][, c("Gene", "logFC") ]
    for(i in 2:length(omicsList)){
      gene_table <- rbind(gene_table, omicsList[[i]][["limmaRes_sig"]][, c("Gene", "logFC") ])
    }
    runEnrichR(gene_table, type="combined" )
  }

  output_links <- paste("[ ",omicsList[[1]][["dataType"]], "-Up ](", output_contrast_subdir,"/enrichr_results_",omicsList[[1]][["dataType"]],"_up.txt) | ",
                        "[ ",omicsList[[1]][["dataType"]], "-Down ](", output_contrast_subdir,"/enrichr_results_",omicsList[[1]][["dataType"]],"_down.txt)", sep="")
  if(length(omicsList)>1) {  for (i in 2:length(omicsList)){
    add_link <- paste("[ ",omicsList[[i]][["dataType"]], "-Up ](", output_contrast_subdir,"/enrichr_results_",omicsList[[i]][["dataType"]],"_up.txt) | ",
                      "[ ",omicsList[[i]][["dataType"]], "-Down ](", output_contrast_subdir,"/enrichr_results_",omicsList[[i]][["dataType"]],"_down.txt)", sep="")
    output_links <- paste(output_links, add_link, sep="  \n" )
  } }
}

```
`r if(enrichr_section){"Click below to view enrichR results:  "}`
`r if(enrichr_section){ if(output_links != ""){ output_links }} `   

---

### Save Data
```{r, message=FALSE }
# save for omics integrator, expression matrix, expression set RDS, ranked list for GSEA

for(i in 1:length(omicsList)){
  saveTheFilesDiff(omicsList[[i]][["eSet"]], topTable(omicsList[[i]][["fit"]], coef=1, adjust.method="BH", 
                                      n=Inf, sort.by = 'logFC'), type=omicsList[[i]][["dataType"]])
}

if(length(omicsList)>1){
  ranked <- cbind(omicsList[[1]][["limmaRes"]][,"Gene"], sign(omicsList[[1]][["limmaRes"]][,"logFC"]) * -log10(omicsList[[1]][["limmaRes"]][,"adj.P.Val"])) 
  
  if(length(omicsList)>1) { for(i in 2:length(omicsList)){
    ranked1 <- cbind(omicsList[[i]][["limmaRes"]][,"Gene"], sign(omicsList[[i]][["limmaRes"]][,"logFC"]) * -log10(omicsList[[i]][["limmaRes"]][,"adj.P.Val"]))
    ranked <- rbind(ranked, ranked1)
  } }
  
  colnames(ranked)<-c("GeneName", "rank")
  ranked <- ranked[ranked[,"GeneName"]!="", ]
  ranked <- ranked[order(abs(as.numeric(ranked[,"rank"])), decreasing=TRUE),]
  ranked <- ranked[!duplicated(ranked[,"GeneName"]),]
  ranked <- ranked[order(as.numeric(ranked[,"rank"]), decreasing=TRUE),]
  output_filename <- file.path(output_contrast_path,"GSEA_rankedlist_combined.rnk");
  write.table(x=ranked, file=output_filename, sep='\t',row.names=FALSE, col.names=TRUE, quote=FALSE)
}
  
if(runDifferential==TRUE && saveXlsx==TRUE){   
  
  wbOut <- createWorkbook()

  for(i in 1:length(omicsList)){
    writeDataToSheetsDiff(wb=wbOut, eset=omicsList[[i]][["eSet"]], limmaRes=omicsList[[i]][["limmaRes"]], type=omicsList[[i]][["dataType"]]); 
  }  
  
  output_filename=file.path(output_path, paste(project_name, "_Summary_", gsub("\\.","",contrastgroups[2]), "-",gsub("\\.","",contrastgroups[1]), ".xlsx", sep=""))
  saveWorkbook(wbOut, file=output_filename, overwrite=TRUE)
  
}

```

---

`r if(gsea_section){"### GSEA and EnrichmentMap"}`
```{r, results='hide', message=FALSE, warning=FALSE, error=FALSE}
output_network_file <- FALSE

if(gsea_section==TRUE) {
  tryCatch(expr = { library(RCurl)}, 
         error = function(e) { install.packages("RCurl")}, finally = library(RCurl))
  tryCatch(expr = { library(httr)}, 
         error = function(e) { install.packages("httr")}, finally = library(httr))
  tryCatch(expr = { library(RJSONIO)}, 
         error = function(e) { install.packages("RJSONIO")}, finally = library(RJSONIO))
  
  gsea_jar <- "/project/cnsbomic/Tools/gsea-3.0.jar"
  analysis_name <- gsub("-","_",gsub("\\.","",colnames(omicsList[[1]][["dt"]])))
  gsea_working_dir <- gsub("\\.", "_", paste("GSEA_", analysis_name, sep=""))
  gsea_working_path <- file.path(output_path, gsea_working_dir)
  if( dir.exists(gsea_working_path) == FALSE ) { dir.create(gsea_working_path) }
  
  if(length(omicsList)>1){ rnk_file <- paste(output_contrast_path, "GSEA_rankedlist_combined.rnk", sep="/")
  } else { rnk_file <- paste(output_contrast_path,"/GSEA_rankedlist_",omicsList[[i]][["dataType"]],".rnk", sep="") }
  
  expression_file <- file.path(paste(output_files_subdir, "/Expression_matrix_",omicsList[[1]][["dataType"]],".txt", sep=""))

  # Only if you need a new GMT file
  gmt_url = "http://download.baderlab.org/EM_Genesets/current_release/Human/symbol/"
  filenames = getURL(gmt_url)   #list all the files on the server
  tc = textConnection(filenames)
  contents = readLines(tc)
  close(tc)
  #get the gmt that has all the pathways and does not include terms inferred from electronic annotations(IEA), start with gmt file that has pathways only
  rx = gregexpr("(?<=<a href=\")(.*.GOBP_AllPathways_no_GO_iea.*.)(.gmt)(?=\">)",
                contents, perl = TRUE)
  gmt_file = unlist(regmatches(contents, rx))
  dest_gmt_file <- paste(gsea_working_path,paste("Supplementary_Table3_",gmt_file,sep="") ,sep="/")
  download.file(paste(gmt_url,gmt_file,sep=""),destfile=dest_gmt_file)

  if(run_gsea){
    command <- paste("java  -Xmx1G -cp",gsea_jar,  "xtools.gsea.GseaPreranked -gmx",
                     dest_gmt_file, "-rnk" , rnk_file,
                     #"-cls",paste(working.dir,cls_filename,sep="/"),
                     "-collapse false -nperm 1000 -permute gene_set -scoring_scheme weighted -rpt_label",
                     analysis_name,"  -num 100 -plot_top_x 20 -rnd_seed 12345  -set_max 200 -set_min 15", 
                     "-zip_report false -out" ,gsea_working_path, "-gui false > ",
                     paste(gsea_working_path,"gsea_output.txt", sep="/"),sep=" ")
    system(command)
    tmp<-list.files(working_dir) #clean up default output folder
    tmp<-tmp[file.info(tmp)$isdir==TRUE]
    tmp<-tmp[!is.na(tmp)]
    if(length(tmp)==1){
      if(nchar(tmp[1])==5){file.remove(paste(working_dir, tmp[1], sep="/")) }
    } 
  }
}

if(enrichment_map && gsea_section){
  #use easy cyRest library to communicate with cytoscape.
  tryCatch(expr = { library(devtools)}, 
         error = function(e) { install.packages("devtools")}, finally = library(devtools))
  tryCatch(expr = { library(r2cytoscape)}, 
          error = function(e) { install_github('cytoscape/cytoscape-automation/for-scripters/R/r2cytoscape')},
          finally = library(r2cytoscape))
  tryCatch(expr = { library(EasycyRest)}, 
          error = function(e) { install_github('BaderLab/Easycyrest/EasycyRest')},
          finally = library(EasycyRest))
    
  gsea_directories <- list.files(path = gsea_working_path, pattern = "\\.GseaPreranked")
  details = file.info(gsea_directories) #get the details on the files
  details = details[with(details, order(as.POSIXct(mtime),decreasing = TRUE)), ]
  gsea_output_dir <- row.names(details)[1]   #use the newest file
  gsea_output_path <- paste(gsea_working_path, gsea_output_dir, sep="/")
  
  # Basic settings
  port.number = 1234
  base.url = paste("http://localhost:", toString(port.number), "/v1", sep="")
  #print(base.url)
  version.url = paste(base.url, "version", sep="/")
  cytoscape.open = TRUE
  tryCatch(expr = { GET(version.url)}, 
         error = function(e) { return (cytoscape.open = FALSE)},
         finally =function(r){ return(cytoscape.open = TRUE)})
  
  if(!cytoscape.open){
  #try and launch cytoscape
    print("Cytoscape is not open.  Please launch cytoscape.")
  } else{
    cytoscape.version =  GET(version.url)
    cy.version = fromJSON(rawToChar(cytoscape.version$content))
    print(cy.version)
  } 

  # MOVE TO PYTHON VARAIBLES SCRIPT EVERNTUALLY
  #defined threshold for GSEA enrichments (need to be strings for cyrest call)
  pvalue_gsea_threshold <- enrichmentmap_p_val
  qvalue_gsea_threshold <- enrichmentmap_q_val
  similarity_threshold <- "0.375"
  similarity_metric = "COMBINED"

  cur_model_name <- analysis_name
  gsea_results_path <- paste(gsea_output_path,"edb",sep="/")
  gsea_results_filename <- paste(gsea_results_path,"results.edb",sep="/")

  # Although there is a gmt file in the gsea edb results directory it have been filtered to contain only genes represented in the expression set.  
  # If you use this fltered file you will get different pathway connectivity depending on the dataset being used.  
  # We recommend using original gmt file used for the gsea analysis and not the filtered one in the results directory.
  gmt_gsea_file <- paste(dest_gmt_file,sep="/")

  current_network_name <- paste(cur_model_name,pvalue_gsea_threshold,qvalue_gsea_threshold,sep="_")

  em_command = paste('enrichmentmap build analysisType="gsea" gmtFile=',gmt_gsea_file,
                   'pvalue=',pvalue_gsea_threshold, 'qvalue=',qvalue_gsea_threshold,
                   'similaritycutoff=',similarity_threshold,
                   'coefficients=',similarity_metric,
                   'ranksDataset1=',rnk_file,
                   'enrichmentsDataset1=',gsea_results_filename, 'filterByExpressions=false',
                   'expressionDataset1=',paste(working_dir,expression_file,sep="/"),
                   sep=" ")

  #enrichment map command will return the suid of newly created network.
  response <- commandRun(em_command)

  current_network_suid <- 0
  #enrichment map command will return the suid of newly created network unless it Failed.  If it failed it will contain the word failed
  if(length(response)>0){ #fix for not getting suid
    if(grepl(pattern="Failed", response)){
      paste(response)
    } else {
      current_network_suid <- response
      response <- renameNetwork(new.name = current_network_name, network = current_network_suid, base.url)
  
      output_network_file <- paste(gsea_working_path,"screenshot_network.pdf",sep="/")
      em_command2 = paste("view export OutputFile= ",output_network_file, " options=PDF", sep="")
      commandRun(em_command2)
      em_command2 = paste("session save as file= ",paste(output_path,analysis_name,sep="/"), sep="")
      commandRun(em_command2)
    }
  }
}

```

`r if(gsea_section){ paste("[ GSEA Results ](",output_subdir,"/",gsea_working_dir,"/",gsea_output_dir,"/index.html)", sep="") }`
`r if(enrichment_map & output_network_file!=FALSE){ paste(" | [ EnrichmentMap Image](",output_subdir,"/",gsea_working_dir,"/screenshot_network.pdf)", sep="") }`

